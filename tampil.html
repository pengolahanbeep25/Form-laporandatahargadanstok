<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabel Data Stok & Harga</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: url("https://assets.promediateknologi.id/crop/0x0:0x0/0x0/webp/photo/p3/155/2025/04/10/Screen-Shot-2025-04-10-at-224530-3222523999.png") no-repeat center center fixed;
      background-size: cover;
      padding: 20px;
      margin: 0;
    }
    header {
      background: rgba(21, 71, 52, 0.95);
      color: white;
      text-align: center;
      padding: 15px 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      backdrop-filter: blur(3px);
    }
    h2 { margin: 10px 0; }
    .content {
      background: rgba(255, 255, 255, 0.92);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      backdrop-filter: blur(4px);
    }
    .filter-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    select, input[type="text"] {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
    }
    input[type="text"] { width: 200px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 13px;
      text-align: left;
      word-wrap: break-word;
      max-width: 150px;
    }
    th {
      background: #2d6a4f;
      color: white;
      text-align: center;
    }
    tr:nth-child(even) { background: #f2f2f2; }
    button, .btn-action {
      background: #2d6a4f;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover, .btn-action:hover { background: #1b4332; }
    .action-bar {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .btn-danger {
      background: #d9534f;
    }
    .btn-danger:hover { background: #c9302c; }
    .total-box {
      margin-top: 15px;
      font-weight: 600;
      font-size: 14px;
      color: #1b4332;
      background: #e9f5ee;
      border: 1px solid #b7dfc4;
      padding: 10px;
      border-radius: 6px;
      width: fit-content;
    }
    @media print {
      @page {
        size: legal landscape;
        margin: 10mm;
      }
      .filter-container, .action-bar, button {
        display: none;
      }
      body {
        background: none;
      }
      .content {
        box-shadow: none;
      }
      table {
        width: 100%;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>üìä Data Laporan Stok & Harga</h2>
  </header>
  <div class="content">
    <div class="filter-container">
      <select id="filterBulan">
        <option value="">üóìÔ∏è Semua Bulan</option>
      </select>
      <select id="filterPenggilingan">
        <option value="">üè≠ Semua Penggilingan</option>
      </select>
      <input type="text" id="search" placeholder="üîç Cari data...">
    </div>

    <div class="action-bar">
      <a href="dashboad.html" class="btn-action">üè† Kembali ke Dashboard</a>
      <button onclick="printTable()">üñ®Ô∏è Print</button>
      <button onclick="downloadExcel()">‚¨áÔ∏è Excel</button>
    </div>

    <div id="data-container">Memuat data...</div>
    <div id="total-container" class="total-box"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  const url = "https://script.google.com/macros/s/AKfycbxrEF7plzQoncqgCN_ShlIR_wzdsfRc6zfpYJaoulU8IGvCrngrbAqTfcUUbLc7d6jqDg/exec";
  let allData = [];

  async function loadData() {
    try {
      const res = await fetch(url);
      const data = await res.json();
      allData = data;
      populateFilters(data);
      renderTable();
    } catch (err) {
      document.getElementById("data-container").innerHTML = "<p style='color:red'>‚ùå Gagal memuat data: " + err + "</p>";
    }
  }

  function getNamaBulan(dateStr) {
    const bulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    const d = new Date(dateStr);
    if (isNaN(d)) return "Tidak diketahui";
    return bulan[d.getMonth()] + " " + d.getFullYear();
  }

  function populateFilters(data) {
    const rows = data.slice(1);
    const bulanSet = new Set();
    const penggilinganSet = new Set();
    rows.forEach(r => {
      const bulan = getNamaBulan(r[0]);
      bulanSet.add(bulan);
      penggilinganSet.add(r[1]);
    });

    const bulanSelect = document.getElementById("filterBulan");
    bulanSelect.innerHTML = `<option value="">üóìÔ∏è Semua Bulan</option>`;
    bulanSet.forEach(b => bulanSelect.innerHTML += `<option value="${b}">${b}</option>`);

    const penggSelect = document.getElementById("filterPenggilingan");
    penggSelect.innerHTML = `<option value="">üè≠ Semua Penggilingan</option>`;
    penggilinganSet.forEach(p => penggSelect.innerHTML += `<option value="${p}">${p}</option>`);
  }

  function getFilteredRows() {
    const rows = allData.slice(1);
    const searchValue = document.getElementById("search").value.toLowerCase();
    const selectedBulan = document.getElementById("filterBulan").value;
    const selectedPenggilingan = document.getElementById("filterPenggilingan").value;

    return rows.filter(row => {
      const bulan = getNamaBulan(row[0]);
      const penggilingan = row[1];
      const cocokBulan = !selectedBulan || bulan === selectedBulan;
      const cocokPenggilingan = !selectedPenggilingan || penggilingan === selectedPenggilingan;
      const cocokSearch = row.join(" ").toLowerCase().includes(searchValue);
      return cocokBulan && cocokPenggilingan && cocokSearch;
    });
  }

  // üëâ Fungsi anti duplikat seperti di Apps Script
  function sumUnique(rows, index) {
    const seen = new Set();
    let total = 0;
    rows.forEach(r => {
      const val = Number(r[index]) || 0;
      if (seen.has(val)) return;
      seen.add(val);
      total += val;
    });
    return total;
  }

  function renderTable() {
    if (allData.length === 0) return;
    const header = allData[0];
    const rows = getFilteredRows();
    let html = `<table><tr>${header.map(h => `<th>${h}</th>`).join("")}<th>Aksi</th></tr>`;
    rows.forEach((row, i) => {
      html += "<tr>";
      row.forEach(cell => html += `<td>${cell}</td>`);
      html += `<td><button class="btn-danger" onclick="hapusData(${i + 2})">Hapus</button></td></tr>`;
    });
    html += "</table>";
    document.getElementById("data-container").innerHTML = html;

    // üëâ TOTAL versi anti-duplikat
    const totalGKP = sumUnique(rows, 4);
    const totalGKG = sumUnique(rows, 8);
    const totalBeras = sumUnique(rows, 12);
    const totalProduksi = sumUnique(rows, 17);

    const ton = n => (n / 1000).toFixed(2);
    document.getElementById("total-container").innerHTML =
      rows.length > 0
      ? `Total Produksi Beras: ${ton(totalProduksi)} Ton | Total Stok GKP: ${ton(totalGKP)} Ton | Total Stok GKG: ${ton(totalGKG)} Ton | Total Stok Beras: ${ton(totalBeras)} Ton`
      : "";
  }

  async function hapusData(row) {
    if (!confirm("Yakin ingin menghapus baris ini?")) return;
    const formData = new FormData();
    formData.append("action", "hapus");
    formData.append("row", row);
    await fetch(url, { method: "POST", body: formData });
    loadData();
  }

  function printTable() { window.print(); }

  // üëâ Excel export pakai sumUnique (anti duplikat)
  function downloadExcel() {
    const rows = getFilteredRows();
    const header = allData[0];
    const data = [header, ...rows];
    const ws = XLSX.utils.aoa_to_sheet(data);

    const total = [
      [],
      [`Total Produksi Beras: ${(sumUnique(rows,17) / 1000).toFixed(2)} Ton`],
      [`Total Stok GKP: ${(sumUnique(rows,4) / 1000).toFixed(2)} Ton`],
      [`Total Stok GKG: ${(sumUnique(rows,8) / 1000).toFixed(2)} Ton`],
      [`Total Stok Beras: ${(sumUnique(rows,12) / 1000).toFixed(2)} Ton`],
    ];
    XLSX.utils.sheet_add_aoa(ws, total, { origin: -1 });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Laporan");
    XLSX.writeFile(wb, "Laporan_Stok_Harga.xlsx");
  }

  document.getElementById("filterBulan").addEventListener("change", renderTable);
  document.getElementById("filterPenggilingan").addEventListener("change", renderTable);
  document.getElementById("search").addEventListener("input", renderTable);
  loadData();
</script>
</body>
</html>


